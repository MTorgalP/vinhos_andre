<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wine</title>

  <style>
    :root{
      --bg:#0b0b0d;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --border:rgba(255,255,255,.12);
      --r:18px;
      --max:1100px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(900px 600px at 10% -10%, rgba(177,31,53,.28), transparent 60%), var(--bg);
      line-height:1.6;
    }
    .container{max-width:var(--max); margin:0 auto; padding:18px 16px;}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(12px);
      background: rgba(11,11,13,.75);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    a{color:inherit; text-decoration:none}
    .back{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .layout{display:grid; grid-template-columns: 420px 1fr; gap:18px; margin-top:18px;}
    @media(max-width:920px){ .layout{grid-template-columns:1fr;} }
    .img{
      border-radius:22px; overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 16px 36px rgba(0,0,0,.35);
      background: rgba(255,255,255,.04);
    }
    .img img{width:100%; height:520px; object-fit:cover; display:block;}
    .card{
      border-radius:22px; padding:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
    }
    h1{margin:0 0 6px;}
    .sub{color:var(--muted); margin:0 0 12px;}
    .divider{height:1px; background: linear-gradient(90deg, rgba(255,255,255,.25), transparent); margin:12px 0;}
    dt{margin-top:12px; font-weight:700;}
    dd{margin:6px 0 0; color:var(--muted)}
    .empty{font-style:italic; color:rgba(255,255,255,.65)}
    .debug{
      margin-top:18px;
      border-radius: var(--r);
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.25);
      padding: 12px 12px;
      color: rgba(255,255,255,.85);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <header>
    <div class="container">
      <a class="back" href="index.html">← Back</a>
    </div>
  </header>

  <main class="container">
    <div id="content"></div>
    <div id="debug" class="debug">Debug log will appear here…</div>
  </main>

  <script>
    const debugEl = document.getElementById("debug");
    const contentEl = document.getElementById("content");

    function log(line) {
      debugEl.textContent += "\\n" + line;
    }

    function getId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id"); // already decoded
    }

    function safe(v) {
      if (v === null || v === undefined || v === "") return null;
      return String(v);
    }

    async function main() {
      debugEl.textContent = "Starting…";

      const requestedId = getId();
      log("Requested id: " + requestedId);

      if (!requestedId) {
        contentEl.innerHTML = `<div class="card"><h1>Wine not found</h1><p class="sub">Missing ?id=...</p></div>`;
        log("ERROR: Missing id parameter.");
        return;
      }

      let wines;
      try {
        const res = await fetch("data/vinhos.json", { cache: "no-store" });
        log("Fetch data/vinhos.json → HTTP " + res.status);

        if (!res.ok) throw new Error("Could not load data/vinhos.json (HTTP " + res.status + ")");
        wines = await res.json();

        if (!Array.isArray(wines)) {
          throw new Error("vinhos.json is not an array. It must be: [ { ... }, { ... } ]");
        }

        log("Loaded wines: " + wines.length);
        log("Available ids:\\n" + wines.map(w => w.id).join("\\n"));

      } catch (e) {
        contentEl.innerHTML = `<div class="card"><h1>Could not load data</h1><p class="sub">${e.message}</p></div>`;
        log("ERROR: " + e.message);
        return;
      }

      const wine = wines.find(w => w.id === requestedId);
      if (!wine) {
        contentEl.innerHTML = `
          <div class="card">
            <h1>Wine not found</h1>
            <p class="sub">No entry in vinhos.json matches id: <strong>${requestedId}</strong></p>
            <div class="divider"></div>
            <p class="empty">Check the “Available ids” list in the debug box below and compare.</p>
          </div>`;
        log("ERROR: No match for requested id in JSON.");
        return;
      }

      // If keys differ in your JSON, debug will show them:
      log("Matched wine keys: " + Object.keys(wine).join(", "));

      const title = `${wine.nome ?? "Wine"} (${wine.ano ?? ""})`.trim();
      document.title = title;

      const castas = Array.isArray(wine.castas) ? wine.castas.join(", ") : safe(wine.castas);
      const notas = safe(wine.notasProva) ?? safe(wine.notas) ?? safe(wine.tastingNotes);
      const harmonizacao = safe(wine.harmonizacao) ?? safe(wine.foodPairing);
      const temp = safe(wine.temperatura) ?? safe(wine.servingTemperature);

      contentEl.innerHTML = `
        <div class="layout">
          <div class="img">
            <img src="${wine.imagem}" alt="${title}" />
          </div>

          <div class="card">
            <h1>${title}</h1>
            <p class="sub">${wine.regiao ?? ""}${wine.descricaoCurta ? " · " + wine.descricaoCurta : ""}</p>

            <div class="divider"></div>

            <dl>
              <dt>Region</dt><dd>${wine.regiao ?? `<span class="empty">Not specified</span>`}</dd>
              <dt>Grapes</dt><dd>${castas ?? `<span class="empty">Not specified</span>`}</dd>
              <dt>Tasting notes</dt><dd>${notas ?? `<span class="empty">Not specified</span>`}</dd>
              <dt>Food pairing</dt><dd>${harmonizacao ?? `<span class="empty">Not specified</span>`}</dd>
              <dt>Serving temperature</dt><dd>${temp ?? `<span class="empty">Not specified</span>`}</dd>
            </dl>
          </div>
        </div>
      `;

      log("Rendered successfully ✅");
    }

    main();
  </script>
</body>
</html>
